<!DOCTYPE html>
<html>
    <head>
	<title>Regex0r Extension Bar</title>
	<script type="text/javascript">
	    function runSearch() {
		// TODO: make straight quotes also match smart quotes oh god
		var query = document.getElementById("query").value;

		console.log("WTF");
		if (query !== "") {
		    safari.application.activeBrowserWindow.activeTab.page
			.dispatchMessage("regexSearch", {
				searchString: query,
				caseInsensitive: document.getElementById("case").checked,
				multiLine: document.getElementById("multiline").checked
			    });
		}
		console.log("BYE");

		document.getElementById("query").select();
	    }

	    function handleMessage(e) {
		console.log("HELLO: " + e.name);
		if (e.name === "resultCount") {
		    var count = e.message.count;
		    var results = document.getElementById("results");
		    results.textContent = count == 0 ? "No matches" :
			count == 1 ? "1 match" :
			(count + " matches");
		    results.style += " visibility: visible;";
		}
	    }

	    safari.self.browserWindow.addEventListener("message", handleMessage, false);
	</script>

	<style type="text/css">
	    #results {
		color: blue;
		font-weight: bold;
		visibility: hidden;
	    }
	</style>
    </head>
    <body>
	Regexp:
	&nbsp;&nbsp;
	<input type=search id=query name=query value="" title="Enter a regular expression here.">

	<input type=submit name=search value=Search onclick="runSearch()" />

	<input type=checkbox id=case name=case checked=checked /> Case insensitive
	<input type=checkbox id=multiline name=multiline /> Multi-line

	<span id=results>No results</span>
    </body>
</html>
