<!DOCTYPE html>
<html>
    <head>
	<title>Regex0r Extension Bar</title>
	<script type="text/javascript">
	    function runSearch() {
		// TODO: make straight quotes also match smart quotes oh god
		var query = document.getElementById("query").value;

		if (query !== "") {
		    safari.application.activeBrowserWindow.activeTab.page
			.dispatchMessage("regexSearch", {
				searchString: query,
				caseInsensitive: document.getElementById("case").checked,
				multiLine: document.getElementById("multiline").checked
			    });
		}

		document.getElementById("query").select();
	    }

	    function handleMessage(e) {
		if (e.name === "resultCount") {
		    var count = e.message.count;
		    var results = document.getElementById("results");
		    results.textContent = count == 0 ? "No matches" :
			count == 1 ? "1 match" :
			(count + " matches");
		    results.style += " visibility: visible;";
		}
	    }

	    safari.self.browserWindow.addEventListener("message", handleMessage, false);
	</script>

	<style type="text/css">
	    #results {
		color: blue;
		font-weight: bold;
		visibility: hidden;
	    }

	    label {
		margin-right: 2em;
	    }
	</style>
    </head>
    <body>
	Regexp:
	&nbsp;&nbsp;
	/<input type=search id=query name=query value="" title="Enter a regular expression here.">/

	<input type=submit name=search value=Search onclick="runSearch()" />

	<span id=results>No matches</span>

	<input type=checkbox id=case name=case checked=checked /> <label for=case>Case insensitive</label>
	<input type=checkbox id=multiline name=multiline /> <label for=multiline>'^' and '$' match on any line</label>
    </body>
</html>
